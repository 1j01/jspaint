<!DOCTYPE html>
<!-- saved from url=(0092)https://rawgit.com/brendankenny/libtess.js/gh-pages/examples/simple_triangulation/index.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>Simple Triangulation</title>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #poly-view {
        width: 800px;
        height: 800px;
      }
    </style>

    <script src="./lib/libtess.min.js"></script>
    <script src="./src/webgl-draw.js"></script>
    <script src="./src/triangulate.js"></script>
    <script>
      /* global draw, initArrayBuffer, initWebGL, triangulate */

      var polygonFillCanvas = document.createElement("canvas");
      // var polygonOutlineCanvas = document.createElement("canvas");
      var polyViewCanvas;
      var filledMode = true;

      var NUM_VERTS = 500;
      var contours;
      var polyTriangles;

      function init() {
        polyViewCanvas = document.getElementById('poly-view');
        polygonFillCanvas.width = polyViewCanvas.width;
        polygonFillCanvas.height = polyViewCanvas.height;

        initWebGL(polygonFillCanvas);

        contours = [
          new Float32Array(generateNoisyLoop(NUM_VERTS, true, 0.8, 0.1)),
          new Float32Array(generateNoisyLoop(NUM_VERTS, false, 0.4, 10))
        ];
        
        polyTriangles = triangulate(contours);
        initArrayBuffer(polyTriangles);

        draw(filledMode);

        var polyViewCtx = polyViewCanvas.getContext("2d");
        polyViewCtx.drawImage(polygonFillCanvas, 0, 0);

        for(var i=0; i<contours.length; i++){
          var contour = contours[i];
          polyViewCtx.fillStyle = "red";
          for(var j=0; j<contour.length; j+=2){
            polyViewCtx.lineTo(
              (contour[j] + 1) * polygonFillCanvas.width/2,
              (1 - contour[j+1]) * polygonFillCanvas.height/2,
            );
            bresenhamLine(
              (contour[j] + 1) * polygonFillCanvas.width/2,
              (1 - contour[j+1]) * polygonFillCanvas.height/2,
              (contour[(j+2)%contour.length] + 1) * polygonFillCanvas.width/2,
              (1 - contour[(j+3)%contour.length]) * polygonFillCanvas.height/2,
              function(x, y){
                polyViewCtx.fillRect(x, y, 1, 1);
              }
            );
          }
        }
      }

      function bresenhamLine(x1, y1, x2, y2, callback){
        // Bresenham's line algorithm
        x1=~~x1, x2=~~x2, y1=~~y1, y2=~~y2;
        
        var dx = Math.abs(x2 - x1);
        var dy = Math.abs(y2 - y1);
        var sx = (x1 < x2) ? 1 : -1;
        var sy = (y1 < y2) ? 1 : -1;
        var err = dx - dy;
        
        while(1){
          callback(x1, y1);
          
          if(x1===x2 && y1===y2) break;
          var e2 = err*2;
          if(e2 >-dy){ err -= dy; x1 += sx; }
          if(e2 < dx){ err += dx; y1 += sy; }
        }
      }

      function generateNoisyLoop(count, ccw, radius, noiseSize) {
        var verts = new Array(count * 2);
        var thetaPer = Math.PI * 2 / count;
        var backwards = ccw ? -1 : 1;
        for (var i = 0; i < count; i++) {
          var theta = thetaPer * i * backwards;
          var randomRadius = radius * (1 + Math.random() * noiseSize);
          verts[i*2] = Math.cos(theta) * randomRadius;
          verts[i*2+1] = Math.sin(theta) * randomRadius;
        }

        return verts;
      }

      document.addEventListener('DOMContentLoaded', init, false);
    </script>
  </head>

  <body>
    <canvas id="poly-view" width="800" height="800"></canvas>
  
</body></html>